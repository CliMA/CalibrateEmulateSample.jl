<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Sample · CalibrateEmulateSample.jl</title><meta name="title" content="Sample · CalibrateEmulateSample.jl"/><meta property="og:title" content="Sample · CalibrateEmulateSample.jl"/><meta property="twitter:title" content="Sample · CalibrateEmulateSample.jl"/><meta name="description" content="Documentation for CalibrateEmulateSample.jl."/><meta property="og:description" content="Documentation for CalibrateEmulateSample.jl."/><meta property="twitter:description" content="Documentation for CalibrateEmulateSample.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="CalibrateEmulateSample.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">CalibrateEmulateSample.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../contributing/">Contributing</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../examples/sinusoid_example/">Simple example walkthrough</a></li><li><a class="tocitem" href="../examples/lorenz_example/">Lorenz example</a></li><li><a class="tocitem" href="../examples/edmf_example/">Turbulence example</a></li><li><a class="tocitem" href="../examples/Cloudy_example/">Cloudy example</a></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox"/><label class="tocitem" for="menuitem-4-5"><span class="docs-label">Emulator testing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../examples/emulators/regression_2d_2d/">Regression of <span>$\mathbb{R}^2 \to \mathbb{R}^2$</span> smooth function</a></li><li><a class="tocitem" href="../examples/emulators/lorenz_integrator_3d_3d/">Integrating Lorenz 63 with an emulated integrator</a></li><li><a class="tocitem" href="../examples/emulators/global_sens_analysis/">Global Sensitiviy Analysis (GSA) test functions</a></li></ul></li></ul></li><li><a class="tocitem" href="../calibrate/">Calibrate</a></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Emulate</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../emulate/">Emulator</a></li><li><a class="tocitem" href="../GaussianProcessEmulator/">Gaussian Process</a></li><li><a class="tocitem" href="../random_feature_emulator/">Random Features</a></li></ul></li><li class="is-active"><a class="tocitem" href>Sample</a><ul class="internal"><li><a class="tocitem" href="#User-interface"><span>User interface</span></a></li><li class="toplevel"><a class="tocitem" href="#AbstractMCMC-sampling-API"><span>Further details on the implementation</span></a></li><li><a class="tocitem" href="#Use-in-MarkovChainMonteCarlo"><span>Use in MarkovChainMonteCarlo</span></a></li></ul></li><li><a class="tocitem" href="../glossary/">Glossary</a></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-9-1" type="checkbox"/><label class="tocitem" for="menuitem-9-1"><span class="docs-label">CalibrateEmulateSample</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-9-1-1" type="checkbox"/><label class="tocitem" for="menuitem-9-1-1"><span class="docs-label">Emulators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../API/Emulators/">General Interface</a></li><li><a class="tocitem" href="../API/GaussianProcess/">Gaussian Process</a></li><li><a class="tocitem" href="../API/RandomFeatures/">Random Features</a></li></ul></li><li><a class="tocitem" href="../API/MarkovChainMonteCarlo/">MarkovChainMonteCarlo</a></li><li><a class="tocitem" href="../API/Utilities/">Utilities</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Sample</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Sample</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/CalibrateEmulateSample.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/CalibrateEmulateSample.jl/blob/main/docs/src/sample.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="The-Sample-stage"><a class="docs-heading-anchor" href="#The-Sample-stage">The Sample stage</a><a id="The-Sample-stage-1"></a><a class="docs-heading-anchor-permalink" href="#The-Sample-stage" title="Permalink"></a></h1><p>The &quot;sample&quot; part of CES refers to exact sampling from the emulated posterior, in our current framework this is achieved with a <a href="https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo">Markov chain Monte Carlo algorithm</a> (MCMC). Within this paradigm, we want to provide the flexibility to use multiple sampling algorithms; the approach we take is to use the general-purpose <a href="https://turing.ml/dev/docs/for-developers/interface">AbstractMCMC.jl</a> API, provided by the <a href="https://turing.ml/dev/">Turing.jl</a> probabilistic programming framework.</p><h2 id="User-interface"><a class="docs-heading-anchor" href="#User-interface">User interface</a><a id="User-interface-1"></a><a class="docs-heading-anchor-permalink" href="#User-interface" title="Permalink"></a></h2><p>We briefly outline an instance of how one sets up and uses MCMC within the CES package. The user first loads the MCMC module, and provides one of the Protocols (i.e. how one wishes to generate sampling proposals)</p><pre><code class="language-julia hljs">using CalibrateEmulateSample.MarkovChainMonteCarlo
protocol = RWMHSampling() # Random-Walk algorithm
# protocol = pCNMHSampling() # preconditioned-Crank-Nicholson algorithm</code></pre><p>Then one builds the MCMC by providing the standard Bayesian ingredients (prior and data) from the calibrate stage, alongside the trained statistical emulator from the emulate stage:</p><pre><code class="language-julia hljs">mcmc = MCMCWrapper(
    protocol,
    truth_sample, 
    prior,
    emulator;
    init_params=mean_u_final,
    burnin=10_000,
)</code></pre><p>The keyword arguments <code>init_params</code> give a starting step of the chain (often taken to be the mean of the final iteration of calibrate stage), and a <code>burnin</code> gives a number of initial steps to be discarded when drawing statistics from the sampling method.</p><div class="admonition is-info"><header class="admonition-header">for many samples</header><div class="admonition-body"><p>If one has several samples of conditionally-independent data (that is, <span>$p({y_1,\dots,y_n}\mid\theta)$</span> is a product of <span>$\prod_i p(y_i\mid\theta)$</span>), then one can feed in <code>truth_sample</code> as a vector of these samples, or a matrix with these samples as columns. The resulting sampler will evaluate the likelihood at all <code>y_i</code> for every sample step. </p></div></div><p>For good efficiency, one often needs to run MCMC with a problem-dependent step size. We provide a simple utility to help choose this. Here the optimizer runs short chains (of length <code>N</code>), and adjusts the step-size until the MCMC acceptance rate falls within an acceptable range, returning this step size.</p><pre><code class="language-julia hljs">new_step = optimize_stepsize(
mcmc;
init_stepsize = 1,
N = 2000
)</code></pre><p>To generate <span>$10^5$</span> samples with a given step size (and optional random number generator <code>rng</code>), one calls</p><pre><code class="language-julia hljs">chain = sample(rng, mcmc, 100_000; stepsize = new_step)
display(chain) # gives diagnostics</code></pre><p>The return argument is stored in an <code>MCMCChains.Chains</code> object. To convert this back into a <code>ParameterDistribution</code> type (which contains e.g. the transformation maps) one can call</p><pre><code class="language-julia hljs">posterior = get_posterior(mcmc, chain)
constrained_posterior = transform_unconstrained_to_constrained(prior, get_distribution(posterior))</code></pre><p>One can quickly plot the marginals of the prior and posterior distribution with</p><pre><code class="language-julia hljs">using Plots
plot(prior)
plot!(posterior)</code></pre><p>or extract statistics of the (unconstrained) distribution with</p><pre><code class="language-julia hljs">mean_posterior = mean(posterior)
cov_posterior = cov(posterior)</code></pre><h1 id="AbstractMCMC-sampling-API"><a class="docs-heading-anchor" href="#AbstractMCMC-sampling-API">Further details on the implementation</a><a id="AbstractMCMC-sampling-API-1"></a><a class="docs-heading-anchor-permalink" href="#AbstractMCMC-sampling-API" title="Permalink"></a></h1><p>This page provides a summary of AbstractMCMC which augments the existing documentation ([<a href="https://turing.ml/dev/docs/for-developers/interface">1</a>], [<a href="https://turing.ml/dev/docs/for-developers/how_turing_implements_abstractmcmc">2</a>]) and highlights how it&#39;s used by the CES package in <a href="../API/MarkovChainMonteCarlo/#MarkovChainMonteCarlo">MarkovChainMonteCarlo</a>. It&#39;s not meant to be a complete description of the AbstractMCMC package.</p><h2 id="Use-in-MarkovChainMonteCarlo"><a class="docs-heading-anchor" href="#Use-in-MarkovChainMonteCarlo">Use in MarkovChainMonteCarlo</a><a id="Use-in-MarkovChainMonteCarlo-1"></a><a class="docs-heading-anchor-permalink" href="#Use-in-MarkovChainMonteCarlo" title="Permalink"></a></h2><p>At present, Turing has limited support for derivative-free optimization, so we only use this abstract API and not Turing itself. We also use two related dependencies, <a href="https://github.com/TuringLang/AdvancedMH.jl">AdvancedMH</a> and <a href="https://github.com/TuringLang/MCMCChains.jl">MCMCChains</a>. </p><p>Julia&#39;s philosophy is to use small, composable packages rather than monoliths, but this can make it difficult to remember where methods are defined! Below we describe the relevant parts of </p><ul><li>The AbstractMCMC API,</li><li>Extended to the case of Metropolis-Hastings (MH) sampling by AdvancedMH,</li><li>Further extended for the needs of CES in <a href="https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo">Markov chain Monte Carlo</a>.</li></ul><h3 id="Sampler"><a class="docs-heading-anchor" href="#Sampler">Sampler</a><a id="Sampler-1"></a><a class="docs-heading-anchor-permalink" href="#Sampler" title="Permalink"></a></h3><p>A Sampler is AbstractMCMC&#39;s term for an implementation of a MCMC sampling algorithm, along with all its configuration parameters. All samplers are a subtype of AbstractMCMC&#39;s <code>AbstractSampler</code>. </p><p>Currently CES only implements the Metropolis-Hastings (MH) algorithm. Because it&#39;s so straightforward, much of AbstractMCMC isn&#39;t needed. We implement two variants of MH with two different Samplers: <code>RWMetropolisHastings</code> and <code>pCNMetropolisHastings</code>, both of which are subtypes of <code>AdvancedMH.MHSampler</code>. The constructor for both Samplers is <a href="../API/MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.MetropolisHastingsSampler"><code>MetropolisHastingsSampler</code></a>; the different Samplers are specified by passing a <a href="../API/MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.MCMCProtocol"><code>MCMCProtocol</code></a> object to this constructor.</p><p>The <code>MHSampler</code> has only one field, <code>proposal</code>, the distribution used to generate new MH proposals via additive stochastic perturbations to the current parameter values. This is done by <a href="https://github.com/TuringLang/AdvancedMH.jl/blob/master/src/proposal.jl">AdvancedMH.propose()</a>, which gets called for each MCMC <code>step()</code>. The difference between Samplers comes from how the proposal is generated:</p><ul><li><p><a href="../API/MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.RWMHSampling"><code>RWMHSampling</code></a> does vanilla random-walk proposal generation with a constant, user-specified step size (this differs from the AdvancedMH implementation, which doesn&#39;t provide for a step size.)</p></li><li><p><a href="../API/MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.pCNMHSampling"><code>pCNMHSampling</code></a> for preconditioned Crank-Nicholson proposals. Vanilla random walk sampling doesn&#39;t have a well-defined limit for high-dimensional parameter spaces; pCN replaces the random walk with an Ornstein–Uhlenbeck [AR(1)] process so that the Metropolis acceptance probability remains non-zero in this limit. See <a href="https://www.worldscientific.com/doi/abs/10.1142/S0219493708002378">Beskos et. al. (2008)</a> and <a href="https://projecteuclid.org/journals/statistical-science/volume-28/issue-3/MCMC-Methods-for-Functions--Modifying-Old-Algorithms-to-Make/10.1214/13-STS421.full">Cotter et. al. (2013)</a>.</p></li></ul><p>Generated proposals are then either accepted or rejected according to the same MH criterion (in <code>step()</code>, below.)</p><h3 id="Models"><a class="docs-heading-anchor" href="#Models">Models</a><a id="Models-1"></a><a class="docs-heading-anchor-permalink" href="#Models" title="Permalink"></a></h3><p>In Turing, the Model is the distribution one performs inference on, which may involve observed and hidden variables and parameters. For CES, we simply want to sample from the posterior, so our Model distribution is simply the emulated likelihood (see <a href="../API/Emulators/#Emulators">Emulators</a>) together with the prior. This is constructed by <a href="../API/MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.EmulatorPosteriorModel"><code>EmulatorPosteriorModel</code></a>.</p><h3 id="Sampling-with-the-MCMC-Wrapper-object"><a class="docs-heading-anchor" href="#Sampling-with-the-MCMC-Wrapper-object">Sampling with the MCMC Wrapper object</a><a id="Sampling-with-the-MCMC-Wrapper-object-1"></a><a class="docs-heading-anchor-permalink" href="#Sampling-with-the-MCMC-Wrapper-object" title="Permalink"></a></h3><p>At a <a href="https://turing.ml/dev/docs/using-turing/guide">high level</a>, a Sampler and Model is all that&#39;s needed to do MCMC sampling. This is done by the <a href="https://turinglang.org/AbstractMCMC.jl/dev/api/#Sampling-a-single-chain"><code>sample</code></a> method provided by AbstractMCMC (extending the method from BaseStats). </p><p>To be more user-friendly, in CES we wrap the Sampler, Model and other necessary configuration into a <a href="../API/MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.MCMCWrapper"><code>MCMCWrapper</code></a> object. The constructor for this object ensures that all its components are created consistently, and performs necessary bookkeeping, such as converting coordinates to the decorrelated basis. We extend <a href="../API/MarkovChainMonteCarlo/#StatsBase.sample"><code>sample</code></a> with methods to use this object (that simply unpack its fields and call the appropriate method from AbstractMCMC.)</p><h3 id="Chain"><a class="docs-heading-anchor" href="#Chain">Chain</a><a id="Chain-1"></a><a class="docs-heading-anchor-permalink" href="#Chain" title="Permalink"></a></h3><p>The <a href="https://beta.turing.ml/MCMCChains.jl/dev/">MCMCChain</a> package provides the <code>Chains</code> container to store the results of the MCMC sampling; the package provides methods to for quick diagnostics and plot utilities of the the <code>Chains</code> objects. For example,</p><pre><code class="language-julia hljs">using MCMCChains
using StatsPlots

# ... from our MCMC example above ...
# chain = sample(rng, mcmc, 100_000; stepsize = new_step)

display(chain) # diagnostics
plot(chain) # plots samples over iteration and PDFs for each parameter</code></pre><h3 id="Internals:-Transitions"><a class="docs-heading-anchor" href="#Internals:-Transitions">Internals: Transitions</a><a id="Internals:-Transitions-1"></a><a class="docs-heading-anchor-permalink" href="#Internals:-Transitions" title="Permalink"></a></h3><p>Implementing MCMC involves defining states and transitions of a Markov process (whose stationary distribution is what we seek to sample from). AbstractMCMC&#39;s terminology is a bit confusing for the MH case; <em>states</em> of the chain are described by <code>Transition</code> objects, which contain the current sample (and other information like its log-probability). </p><p>AdvancedMH defines an <code>AbstractTransition</code> base class for use with its methods; we implement our own child class, <a href="../API/MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.MCMCState"><code>MCMCState</code></a>, in order to record statistics on the MH acceptance ratio.</p><h3 id="Internals:-Markov-steps"><a class="docs-heading-anchor" href="#Internals:-Markov-steps">Internals: Markov steps</a><a id="Internals:-Markov-steps-1"></a><a class="docs-heading-anchor-permalink" href="#Internals:-Markov-steps" title="Permalink"></a></h3><p>Markov <em>transitions</em> of the chain are defined by overloading AbstractMCMC&#39;s <code>step</code> method, which takes the Sampler and current <code>Transition</code> and implements the Sampler&#39;s logic to returns an updated <code>Transition</code> representing the chain&#39;s new state (actually, a pair of <code>Transitions</code>, for cases where the Sampler doesn&#39;t obey detailed balance; this isn&#39;t relevant for us). </p><p>For example, in Metropolis-Hastings sampling this is where we draw a proposal sample and accept or reject it according to the MH criterion. AdvancedMH implements this <a href="https://github.com/TuringLang/AdvancedMH.jl/blob/ba86e49a3ebd1ee94d0becc3211738e3be6fd538/src/mh-core.jl#L90-L113">here</a>; we re-implement this method because 1) we need to record whether a proposal was accepted or rejected, and 2) our calls to <code>propose()</code> are stepsize-dependent.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../random_feature_emulator/">« Random Features</a><a class="docs-footer-nextpage" href="../glossary/">Glossary »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Monday 12 May 2025 18:01">Monday 12 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Global Sensitiviy Analysis for an emulated Ishigami function · CalibrateEmulateSample.jl</title><meta name="title" content="Global Sensitiviy Analysis for an emulated Ishigami function · CalibrateEmulateSample.jl"/><meta property="og:title" content="Global Sensitiviy Analysis for an emulated Ishigami function · CalibrateEmulateSample.jl"/><meta property="twitter:title" content="Global Sensitiviy Analysis for an emulated Ishigami function · CalibrateEmulateSample.jl"/><meta name="description" content="Documentation for CalibrateEmulateSample.jl."/><meta property="og:description" content="Documentation for CalibrateEmulateSample.jl."/><meta property="twitter:description" content="Documentation for CalibrateEmulateSample.jl."/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.svg" alt="CalibrateEmulateSample.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">CalibrateEmulateSample.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><a class="tocitem" href="../../../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li><li><a class="tocitem" href="../../../calibrate/">Calibrate</a></li><li><a class="tocitem" href="../../../emulate/">Emulate</a></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox" checked/><label class="tocitem" for="menuitem-6"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../sinusoid_example/">Simple example walkthrough</a></li><li><a class="tocitem" href="../../lorenz_example/">Lorenz example</a></li><li><a class="tocitem" href="../../edmf_example/">Turbulence example</a></li><li><a class="tocitem" href="../../Cloudy_example/">Cloudy example</a></li><li><input class="collapse-toggle" id="menuitem-6-5" type="checkbox" checked/><label class="tocitem" for="menuitem-6-5"><span class="docs-label">Emulator testing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../regression_2d_2d/">Regression of <span>$\mathbb{R}^2 \to \mathbb{R}^2$</span> smooth function</a></li><li><a class="tocitem" href="../lorenz_integrator_3d_3d/">Integrating Lorenz 63 with an emulated integrator</a></li><li class="is-active"><a class="tocitem" href>Global Sensitiviy Analysis for an emulated Ishigami function</a><ul class="internal"><li><a class="tocitem" href="#Gaussian-Process-Emulator-(sci-kit-learn-GP)"><span>Gaussian Process Emulator (sci-kit learn <code>GP</code>)</span></a></li><li><a class="tocitem" href="#Random-feature-emulator-(Separable-Low-rank-kernel-RF-scalar)"><span>Random feature emulator (Separable Low-rank kernel <code>RF-scalar</code>)</span></a></li></ul></li></ul></li></ul></li><li><a class="tocitem" href="../../../GaussianProcessEmulator/">Gaussian Process</a></li><li><a class="tocitem" href="../../../random_feature_emulator/">Random Features</a></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">Package Design</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../API/AbstractMCMC/">AbstractMCMC sampling API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox"/><label class="tocitem" for="menuitem-10"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-10-1" type="checkbox"/><label class="tocitem" for="menuitem-10-1"><span class="docs-label">CalibrateEmulateSample</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-10-1-1" type="checkbox"/><label class="tocitem" for="menuitem-10-1-1"><span class="docs-label">Emulators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../API/Emulators/">General Interface</a></li><li><a class="tocitem" href="../../../API/GaussianProcess/">Gaussian Process</a></li><li><a class="tocitem" href="../../../API/RandomFeatures/">Random Features</a></li></ul></li><li><a class="tocitem" href="../../../API/MarkovChainMonteCarlo/">MarkovChainMonteCarlo</a></li><li><a class="tocitem" href="../../../API/Utilities/">Utilities</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li><a class="is-disabled">Emulator testing</a></li><li class="is-active"><a href>Global Sensitiviy Analysis for an emulated Ishigami function</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Global Sensitiviy Analysis for an emulated Ishigami function</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/CalibrateEmulateSample.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/CalibrateEmulateSample.jl/blob/main/docs/src/examples/emulators/ishigami_3d_1d.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Global-Sensitiviy-Analysis-for-an-emulated-Ishigami-function"><a class="docs-heading-anchor" href="#Global-Sensitiviy-Analysis-for-an-emulated-Ishigami-function">Global Sensitiviy Analysis for an emulated Ishigami function</a><a id="Global-Sensitiviy-Analysis-for-an-emulated-Ishigami-function-1"></a><a class="docs-heading-anchor-permalink" href="#Global-Sensitiviy-Analysis-for-an-emulated-Ishigami-function" title="Permalink"></a></h1><p>In this example, we assess directly the performance of our machine learning emulators. The task is to learn a function for use in a <a href="https://en.wikipedia.org/wiki/Variance-based_sensitivity_analysis">global sensitivity analysis</a>. In particular, we learn the Ishigami function</p><p class="math-container">\[f(x; a, b) = (1 + bx_3^4)\sin(x_1) + a \sin(x_2), \forall x\in [-\pi,\pi]^3\]</p><p>with <span>$a=7, b=0.1$</span>. In this example, global sensitivity analysis refers to calculation of two Sobol indices. The first index collects proportions <span>$V_i$</span> (a.k.a <code>firstorder</code>) of the variance of <span>$f$</span> attributable to the input <span>$x_i$</span>, and the second index collects proportions <span>$TV_i$</span> (a.k.a <code>totalorder</code>) of the residual variance having removed contributions attributable to inputs <span>$x_j$</span> <span>$\forall j\neq i$</span>. The Ishigami function has an analytic formula for these Sobol indices, it is also known that one can obtain numerical approximation through quasi-Monto-Carlo methods by evaluating the Ishigami function on a special quasi-random Sobol sequence.</p><p>To emulate the Ishigami function, the data consists of 300 pairs <span>$\{x,f(x)+\eta\}$</span> where <span>$\eta \sim N(0,\Sigma)$</span> is additive noise, and the x are sampled from the Sobol sequence. The emulators are validated by evaluating the posterior mean function on the full 16000 points of the Sobol sequence and the Sobol indices are estimated. We rerun the experiment for many repeats of the random feature hyperparameter optimization and present the statistics of these indices, as well as plotting a realization of the emulator.</p><p>We use the package <a href="https://github.com/lrennels/GlobalSensitivityAnalysis.jl">GlobalSensitivityAnalysis.jl</a> for many of the GSA tools.</p><h3 id="Walkthrough-of-the-code"><a class="docs-heading-anchor" href="#Walkthrough-of-the-code">Walkthrough of the code</a><a id="Walkthrough-of-the-code-1"></a><a class="docs-heading-anchor-permalink" href="#Walkthrough-of-the-code" title="Permalink"></a></h3><p>We first load some standard packages</p><pre><code class="language-julia hljs">using Distributions
using DataStructures # for `OrderedDict`
using Random
using LinearAlgebra
using CairoMakie, ColorSchemes </code></pre><p>and the packages for providing the Ishigami function, Sobol sequence, and evaluation of the indices</p><pre><code class="language-julia hljs">using GlobalSensitivityAnalysis # for `SobolData`
const GSA = GlobalSensitivityAnalysis</code></pre><p>then the CES packages for the emulators</p><pre><code class="language-julia hljs">using CalibrateEmulateSample.Emulators # for `SKLJL`, `GaussianProcess`, `SeparableKernel`, `LowRankFactor`, `OneDimFactor`, `ScalarRandomFeatureInterface`, `Emulator`
using CalibrateEmulateSample.DataContainers # for `PairedDataContainer`
using CalibrateEmulateSample.EnsembleKalmanProcesses # for `DataMisfitController`</code></pre><p>We set up the sampling procedure, evaluate the true ishigami function on these points, and calculate the sobol indices</p><pre><code class="language-julia hljs">n_data_gen = 2000 

data = SobolData(
    params = OrderedDict(:x1 =&gt; Uniform(-π, π), :x2 =&gt; Uniform(-π, π), :x3 =&gt; Uniform(-π, π)),
    N = n_data_gen,
)

# To perform global analysis,
# one must generate samples using Sobol sequence (i.e. creates more than N points)
samples = GSA.sample(data)
n_data = size(samples, 1) # [n_samples x 3]
# run model (example)
y = GSA.ishigami(samples)
# perform Sobol Analysis
result = analyze(data, y)</code></pre><p>Next we create the noisy training data from the sequence samples</p><pre><code class="language-julia hljs">n_train_pts = 300
ind = shuffle!(rng, Vector(1:n_data))[1:n_train_pts]
# now subsample the samples data
n_tp = length(ind)
input = zeros(3, n_tp)
output = zeros(1, n_tp)
Γ = 1e-2
noise = rand(rng, Normal(0, Γ), n_tp)
for i in 1:n_tp
    input[:, i] = samples[ind[i], :]
    output[i] = y[ind[i]] + noise[i]
end
iopairs = PairedDataContainer(input, output)</code></pre><p>We have a few cases for the user to investigate</p><pre><code class="language-julia hljs">cases = [
    &quot;Prior&quot;, # Scalar random feature emulator with no hyperparameter learning
    &quot;GP&quot;, # Trained Sci-kit learn Gaussian process emulator
    &quot;RF-scalar&quot;, # Trained scalar random feature emulator
]</code></pre><p>Each case sets up a different machine learning configuration in the <code>Emulator</code> object.</p><p>For the random feature case, <code>RF-scalar</code>, we use a rank-3 kernel in the input space, and 500 features for prediction, though for efficiency we use only 200 when learning the hyperparameters. The relevant code snippets are</p><pre><code class="language-julia hljs">nugget = Float64(1e-12)
overrides = Dict(
    &quot;scheduler&quot; =&gt; DataMisfitController(terminate_at = 1e4),
    &quot;n_features_opt&quot; =&gt; 200,
)

kernel_structure = SeparableKernel(LowRankFactor(3, nugget), OneDimFactor())
n_features = 500
mlt = ScalarRandomFeatureInterface(
    n_features,
    3,
    rng = rng,
    kernel_structure = kernel_structure,
    optimizer_options = overrides,
)</code></pre><p>For the gaussian process case <code>GP</code> we use the sci-kit learn package, a default squared exponential kernel with lengthscale learnt in each input dimensions. We do not learn an additional white kernel for the noise.</p><pre><code class="language-julia hljs">gppackage = Emulators.SKLJL()
pred_type = Emulators.YType()
mlt = GaussianProcess(
    gppackage;
    prediction_type = pred_type,
    noise_learn = false,
)</code></pre><p>We finish by building the emulator object</p><pre><code class="language-julia hljs">emulator = Emulator(mlt, iopairs; obs_noise_cov = Γ * I, decorrelate = decorrelate)
optimize_hyperparameters!(emulator) # (only needed for some Emulator packages)</code></pre><h3 id="Results-and-plots"><a class="docs-heading-anchor" href="#Results-and-plots">Results and plots</a><a id="Results-and-plots-1"></a><a class="docs-heading-anchor-permalink" href="#Results-and-plots" title="Permalink"></a></h3><p>We validate the emulator by evaluating it on the entire Sobol sequence, and calculating the Sobol indices (presenting mean and std if using multiple repeats.</p><pre><code class="language-julia hljs"># predict on all Sobol points with emulator (example)    
y_pred, y_var = predict(emulator, samples&#39;, transform_to_real = true)

# obtain emulated Sobol indices
result_pred = analyze(data, y_pred&#39;)</code></pre><h2 id="Gaussian-Process-Emulator-(sci-kit-learn-GP)"><a class="docs-heading-anchor" href="#Gaussian-Process-Emulator-(sci-kit-learn-GP)">Gaussian Process Emulator (sci-kit learn <code>GP</code>)</a><a id="Gaussian-Process-Emulator-(sci-kit-learn-GP)-1"></a><a class="docs-heading-anchor-permalink" href="#Gaussian-Process-Emulator-(sci-kit-learn-GP)" title="Permalink"></a></h2><p>Here is the plot for one emulation</p><img src="../../../assets/ishigami_slices_GP.png" width="600"><p>and the outputted table of Sobol indices</p><pre><code class="nohighlight hljs">True Sobol Indices
******************
    firstorder: [0.31390519114781146, 0.44241114479004084, 0.0]
    totalorder: [0.5575888552099592, 0.44241114479004084, 0.24368366406214775]
 
Sampled truth Sobol Indices (# points 16000)
***************************
    firstorder: [0.31261591941512257, 0.441887746224135, -0.005810964687365922]
    totalorder: [0.5623611180844434, 0.44201284296404386, 0.24465876318633062]
 
Sampled Emulated Sobol Indices (# obs 300, noise var 0.01)
***************************************************************
    firstorder: [0.3094638183079643, 0.4518400892052567, -0.007351344957260407]
    totalorder: [0.5502469909342245, 0.4587734278791574, 0.23542404141319245]</code></pre><h2 id="Random-feature-emulator-(Separable-Low-rank-kernel-RF-scalar)"><a class="docs-heading-anchor" href="#Random-feature-emulator-(Separable-Low-rank-kernel-RF-scalar)">Random feature emulator (Separable Low-rank kernel <code>RF-scalar</code>)</a><a id="Random-feature-emulator-(Separable-Low-rank-kernel-RF-scalar)-1"></a><a class="docs-heading-anchor-permalink" href="#Random-feature-emulator-(Separable-Low-rank-kernel-RF-scalar)" title="Permalink"></a></h2><p>Here is the plot for one emulation</p><img src="../../../assets/ishigami_slices_RF-scalar.png" width="600"><p>Table for 20 repeats of the algorithm</p><pre><code class="nohighlight hljs">True Sobol Indices
******************
    firstorder: [0.31390519114781146, 0.44241114479004084, 0.0]
    totalorder: [0.5575888552099592, 0.44241114479004084, 0.24368366406214775]
 
Sampled truth Sobol Indices (# points 16000)
***************************
    firstorder: [0.31261591941512257, 0.441887746224135, -0.005810964687365922]
    totalorder: [0.5623611180844434, 0.44201284296404386, 0.24465876318633062]
 
Sampled Emulated Sobol Indices (# obs 300, noise var 0.01)
***************************************************************
(mean) firstorder: [0.33605548545490044, 0.41116050093679196, -0.0012213648484969539]
(std)  firstorder: [0.05909336956162543, 0.11484966121124164, 0.012908533302492602]
(mean) totalorder: [0.5670345355855254, 0.4716028261179354, 0.24108222433317]
(std)  totalorder: [0.10619345801872732, 0.1041023777237331, 0.07200225781785778]
</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../lorenz_integrator_3d_3d/">« Integrating Lorenz 63 with an emulated integrator</a><a class="docs-footer-nextpage" href="../../../GaussianProcessEmulator/">Gaussian Process »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Thursday 4 January 2024 22:17">Thursday 4 January 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

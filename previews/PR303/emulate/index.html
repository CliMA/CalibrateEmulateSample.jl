<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Emulator · CalibrateEmulateSample.jl</title><meta name="title" content="Emulator · CalibrateEmulateSample.jl"/><meta property="og:title" content="Emulator · CalibrateEmulateSample.jl"/><meta property="twitter:title" content="Emulator · CalibrateEmulateSample.jl"/><meta name="description" content="Documentation for CalibrateEmulateSample.jl."/><meta property="og:description" content="Documentation for CalibrateEmulateSample.jl."/><meta property="twitter:description" content="Documentation for CalibrateEmulateSample.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="CalibrateEmulateSample.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">CalibrateEmulateSample.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../contributing/">Contributing</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../examples/sinusoid_example/">Simple example walkthrough</a></li><li><a class="tocitem" href="../examples/lorenz_example/">Lorenz example</a></li><li><a class="tocitem" href="../examples/edmf_example/">Turbulence example</a></li><li><a class="tocitem" href="../examples/Cloudy_example/">Cloudy example</a></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox"/><label class="tocitem" for="menuitem-4-5"><span class="docs-label">Emulator testing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../examples/emulators/regression_2d_2d/">Regression of <span>$\mathbb{R}^2 \to \mathbb{R}^2$</span> smooth function</a></li><li><a class="tocitem" href="../examples/emulators/lorenz_integrator_3d_3d/">Integrating Lorenz 63 with an emulated integrator</a></li><li><a class="tocitem" href="../examples/emulators/ishigami_3d_1d/">Global Sensitiviy Analysis for an emulated Ishigami function</a></li></ul></li></ul></li><li><a class="tocitem" href="../calibrate/">Calibrate</a></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox" checked/><label class="tocitem" for="menuitem-6"><span class="docs-label">Emulate</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Emulator</a><ul class="internal"><li><a class="tocitem" href="#Typical-construction-from-Lorenz_example.jl"><span>Typical construction from <code>Lorenz_example.jl</code></span></a></li><li><a class="tocitem" href="#Data-processing"><span>Data processing</span></a></li><li><a class="tocitem" href="#modular-interface"><span>Modular interface</span></a></li></ul></li><li><a class="tocitem" href="../GaussianProcessEmulator/">Gaussian Process</a></li><li><a class="tocitem" href="../random_feature_emulator/">Random Features</a></li></ul></li><li><a class="tocitem" href="../sample/">Sample</a></li><li><a class="tocitem" href="../glossary/">Glossary</a></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-9-1" type="checkbox"/><label class="tocitem" for="menuitem-9-1"><span class="docs-label">CalibrateEmulateSample</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-9-1-1" type="checkbox"/><label class="tocitem" for="menuitem-9-1-1"><span class="docs-label">Emulators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../API/Emulators/">General Interface</a></li><li><a class="tocitem" href="../API/GaussianProcess/">Gaussian Process</a></li><li><a class="tocitem" href="../API/RandomFeatures/">Random Features</a></li></ul></li><li><a class="tocitem" href="../API/MarkovChainMonteCarlo/">MarkovChainMonteCarlo</a></li><li><a class="tocitem" href="../API/Utilities/">Utilities</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Emulate</a></li><li class="is-active"><a href>Emulator</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Emulator</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/CalibrateEmulateSample.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/CalibrateEmulateSample.jl/blob/main/docs/src/emulate.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="The-Emulate-stage"><a class="docs-heading-anchor" href="#The-Emulate-stage">The Emulate stage</a><a id="The-Emulate-stage-1"></a><a class="docs-heading-anchor-permalink" href="#The-Emulate-stage" title="Permalink"></a></h1><p>Emulation is performed through the construction of an <code>Emulator</code> object, which has two components</p><ol><li>A wrapper for any statistical emulator,</li><li>Data-processing and dimensionality reduction functionality.</li></ol><h2 id="Typical-construction-from-Lorenz_example.jl"><a class="docs-heading-anchor" href="#Typical-construction-from-Lorenz_example.jl">Typical construction from <code>Lorenz_example.jl</code></a><a id="Typical-construction-from-Lorenz_example.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Typical-construction-from-Lorenz_example.jl" title="Permalink"></a></h2><p>First, obtain data in a <code>PairedDataContainer</code>, for example, get this from an <code>EnsembleKalmanProcess</code> <code>ekpobj</code> generated during the <code>Calibrate</code> stage, or see the constructor <a href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/main/src/DataContainers.jl">here</a></p><pre><code class="language-julia hljs">using CalibrateEmulateSample.Utilities
input_output_pairs = Utilities.get_training_points(ekpobj, 5) # use first 5 iterations as data</code></pre><p>Wrapping a predefined machine learning tool, e.g. a Gaussian process <code>gauss_proc</code>, the <code>Emulator</code> can then be built:</p><pre><code class="language-julia hljs">emulator = Emulator(
    gauss_proc, 
    input_output_pairs; # optional arguments after this
    obs_noise_cov = Γy,
    normalize_inputs = true,
    standardize_outputs = true,
    standardize_outputs_factors = factor_vector,
    retained_svd_frac = 0.95,
)</code></pre><p>The optional arguments above relate to the data processing.</p><h3 id="Emulator-Training"><a class="docs-heading-anchor" href="#Emulator-Training">Emulator Training</a><a id="Emulator-Training-1"></a><a class="docs-heading-anchor-permalink" href="#Emulator-Training" title="Permalink"></a></h3><p>The emulator is trained when we combine the machine learning tool and the data into the <code>Emulator</code> above.  For any machine learning tool, hyperparameters are optimized.</p><pre><code class="language-julia hljs">optimize_hyperparameters!(emulator)</code></pre><p>For some machine learning packages however, this may be completed during construction automatically, and for others this will not. If automatic construction took place, the <code>optimize_hyperparameters!</code> line does not perform any new task, so may be safely called. In the Lorenz example, this line learns the hyperparameters of the Gaussian process, which depend on the choice of <a href="https://clima.github.io/CalibrateEmulateSample.jl/dev/GaussianProcessEmulator/#kernels">kernel</a>, and the choice of GP package. Predictions at new inputs can then be made using</p><pre><code class="language-julia hljs">y, cov = Emulator.predict(emulator, new_inputs)</code></pre><p>This returns both a mean value and a covariance.</p><h2 id="Data-processing"><a class="docs-heading-anchor" href="#Data-processing">Data processing</a><a id="Data-processing-1"></a><a class="docs-heading-anchor-permalink" href="#Data-processing" title="Permalink"></a></h2><p>Some effects of the following are outlined in a practical setting in the results and appendices of <a href="https://doi.org/10.1029/2021MS002735">Howland, Dunbar, Schneider, (2022)</a>.</p><h3 id="Diagonalization-and-output-dimension-reduction"><a class="docs-heading-anchor" href="#Diagonalization-and-output-dimension-reduction">Diagonalization and output dimension reduction</a><a id="Diagonalization-and-output-dimension-reduction-1"></a><a class="docs-heading-anchor-permalink" href="#Diagonalization-and-output-dimension-reduction" title="Permalink"></a></h3><p>This arises from the optional arguments</p><ul><li><code>obs_noise_cov = Γy</code> (default: <code>nothing</code>)</li></ul><p>We always use singular value decomposition to diagonalize the output space, requiring output covariance <code>Γy</code>. <em>Why?</em> If we need to train a <span>$\mathbb{R}^{10} \to \mathbb{R}^{100}$</span> emulator, diagonalization allows us to instead train 100 <span>$\mathbb{R}^{10} \to \mathbb{R}^{1}$</span> emulators (far cheaper).</p><ul><li><code>retained_svd_frac = 0.95</code> (default <code>1.0</code>)</li></ul><p>Performance is increased further by throwing away less informative output dimensions, if 95% of the information (i.e., variance) is in the first 40 diagonalized output dimensions then setting <code>retained_svd_frac=0.95</code> will train only 40 emulators.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Diagonalization is an approximation. It is however a good approximation when the observational covariance varies slowly in the parameter space.</p></div></div><div class="admonition is-category-warn"><header class="admonition-header">Warn</header><div class="admonition-body"><p>Severe approximation errors can occur if <code>obs_noise_cov</code> is not provided.</p></div></div><h3 id="Normalization-and-standardization"><a class="docs-heading-anchor" href="#Normalization-and-standardization">Normalization and standardization</a><a id="Normalization-and-standardization-1"></a><a class="docs-heading-anchor-permalink" href="#Normalization-and-standardization" title="Permalink"></a></h3><p>This arises from the optional arguments</p><ul><li><code>normalize_inputs = true</code> (default: <code>true</code>)</li></ul><p>We normalize the input data in a standard way by centering, and scaling with the empirical covariance</p><ul><li><code>standardize_outputs = true</code> (default: <code>false</code>)</li><li><code>standardize_outputs_factors = factor_vector</code> (default: <code>nothing</code>)</li></ul><p>To help with poor conditioning of the covariance matrix, users can also standardize each output dimension with by a multiplicative factor given by the elements of <code>factor_vector</code>.</p><h2 id="modular-interface"><a class="docs-heading-anchor" href="#modular-interface">Modular interface</a><a id="modular-interface-1"></a><a class="docs-heading-anchor-permalink" href="#modular-interface" title="Permalink"></a></h2><p>Developers may contribute new tools by performing the following</p><ol><li>Create <code>MyMLToolName.jl</code>, and include &quot;MyMLToolName.jl&quot; in <code>Emulators.jl</code></li><li>Create a struct <code>MyMLTool &lt;: MachineLearningTool</code>, containing any arguments or optimizer options </li><li>Create the following three methods to build, train, and predict with your tool (use <code>GaussianProcess.jl</code> as a guide)</li></ol><pre><code class="nohighlight hljs">build_models!(mlt::MyMLTool, iopairs::PairedDataContainer) -&gt; Nothing
optimize_hyperparameters!(mlt::MyMLTool, args...; kwargs...) -&gt; Nothing
function predict(mlt::MyMLTool, new_inputs::Matrix; kwargs...) -&gt; Matrix, Union{Matrix, Array{,3}</code></pre><div class="admonition is-info"><header class="admonition-header">on dimensions of the predict inputs and outputs</header><div class="admonition-body"><p>The <code>predict</code> method takes as input, an <code>input_dim</code>-by-<code>N_new</code> matrix. It return both a predicted mean and a predicted (co)variance at new inputs. (i) for scalar-output methods relying on diagonalization, return <code>output_dim</code>-by-<code>N_new</code> matrices for mean and variance, (ii) For vector-output methods, return <code>output_dim</code>-by-<code>N_new</code> for mean and <code>output_dim</code>-by-<code>output_dim</code>-by-<code>N_new</code> for covariances.</p></div></div><p>Please get in touch with our development team when contributing new statistical emulators, to help us ensure the smoothest interface with any new tools.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../calibrate/">« Calibrate</a><a class="docs-footer-nextpage" href="../GaussianProcessEmulator/">Gaussian Process »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Friday 5 April 2024 21:37">Friday 5 April 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

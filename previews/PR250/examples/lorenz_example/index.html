<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Lorenz example · CalibrateEmulateSample.jl</title><meta name="title" content="Lorenz example · CalibrateEmulateSample.jl"/><meta property="og:title" content="Lorenz example · CalibrateEmulateSample.jl"/><meta property="twitter:title" content="Lorenz example · CalibrateEmulateSample.jl"/><meta name="description" content="Documentation for CalibrateEmulateSample.jl."/><meta property="og:description" content="Documentation for CalibrateEmulateSample.jl."/><meta property="twitter:description" content="Documentation for CalibrateEmulateSample.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="CalibrateEmulateSample.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">CalibrateEmulateSample.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li><li><a class="tocitem" href="../../calibrate/">Calibrate</a></li><li><a class="tocitem" href="../../emulate/">Emulate</a></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox" checked/><label class="tocitem" for="menuitem-6"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Lorenz example</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Structure"><span>Structure</span></a></li><li class="toplevel"><a class="tocitem" href="#Inputs"><span>Inputs</span></a></li><li class="toplevel"><a class="tocitem" href="#Running-the-Example-and-Postprocessing"><span>Running the Example and Postprocessing</span></a></li><li><a class="tocitem" href="#Calibrate"><span>Calibrate</span></a></li><li><a class="tocitem" href="#Emulate-sample"><span>Emulate-sample</span></a></li><li class="toplevel"><a class="tocitem" href="#L96-CES-example-case:-GP-regression-emulator"><span>L96 CES example case: GP regression emulator</span></a></li></ul></li><li><a class="tocitem" href="../edmf_example/">Turbulence example</a></li></ul></li><li><a class="tocitem" href="../../GaussianProcessEmulator/">Gaussian Process</a></li><li><a class="tocitem" href="../../random_feature_emulator/">Random Features</a></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">Package Design</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../API/AbstractMCMC/">AbstractMCMC sampling API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox"/><label class="tocitem" for="menuitem-10"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-10-1" type="checkbox"/><label class="tocitem" for="menuitem-10-1"><span class="docs-label">CalibrateEmulateSample</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-10-1-1" type="checkbox"/><label class="tocitem" for="menuitem-10-1-1"><span class="docs-label">Emulators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../API/Emulators/">General Interface</a></li><li><a class="tocitem" href="../../API/GaussianProcess/">Gaussian Process</a></li><li><a class="tocitem" href="../../API/RandomFeatures/">Random Features</a></li></ul></li><li><a class="tocitem" href="../../API/MarkovChainMonteCarlo/">MarkovChainMonteCarlo</a></li><li><a class="tocitem" href="../../API/Utilities/">Utilities</a></li></ul></li></ul></li><li><a class="tocitem" href="../../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Lorenz example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Lorenz example</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/CalibrateEmulateSample.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/CalibrateEmulateSample.jl/blob/main/docs/src/examples/lorenz_example.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Lorenz-96-example"><a class="docs-heading-anchor" href="#Lorenz-96-example">Lorenz 96 example</a><a id="Lorenz-96-example-1"></a><a class="docs-heading-anchor-permalink" href="#Lorenz-96-example" title="Permalink"></a></h1><p>The Lorenz 96 (hereafter L96) example is a toy-problem for the application of the CalibrateEmulateSample.jl optimization and approximate uncertainty quantification methodologies. Here is L96 with additional periodic-in-time forcing, we try to determine parameters (sinusoidal amplitude and stationary component of the forcing) from some output statistics. The standard L96 equations are implemented with an additional forcing term with time dependence. The output statistics which are used for learning are the finite time-averaged variances.</p><p>The standard single-scale L96 equations are implemented. The Lorenz 96 system (<a href="http://www.raidl.cz/file/18/lorenz-1996-_predictability_partly_solved.pdf">Lorenz, 1996</a>) is given by </p><p class="math-container">\[\frac{d x_i}{d t} = (x_{i+1} - x_{i-2}) x_{i-1} - x_i + F,\]</p><p>with <span>$i$</span> indicating the index of the given longitude. The number of longitudes is given by <span>$N$</span>. The boundary conditions are given by</p><p class="math-container">\[x_{-1} = x_{N-1}, \ x_0 = x_N, \ x_{N+1} = x_1.\]</p><p>The time scaling is such that the characteristic time is 5 days (<a href="http://www.raidl.cz/file/18/lorenz-1996-_predictability_partly_solved.pdf">Lorenz, 1996</a>).  For very small values of <span>$F$</span>, the solutions <span>$x_i$</span> decay to <span>$F$</span> after the initial transient feature. For moderate values of <span>$F$</span>, the solutions are periodic, and for larger values of <span>$F$</span>, the system is chaotic. The solution variance is a function of the forcing magnitude. Variations in the base state as a function of time can be imposed through a time-dependent forcing term <span>$F(t)$</span>.</p><p>A temporal forcing term is defined</p><p class="math-container">\[F = F_s + A \sin(\omega t),\]</p><p>with steady-state forcing <span>$F_s$</span>, transient forcing amplitude <span>$A$</span>, and transient forcing frequency <span>$\omega$</span>. The total forcing <span>$F$</span> must be within the chaotic regime of L96 for all time given the prescribed <span>$N$</span>.</p><p>The L96 dynamics are solved with RK4 integration.</p><h1 id="Structure"><a class="docs-heading-anchor" href="#Structure">Structure</a><a id="Structure-1"></a><a class="docs-heading-anchor-permalink" href="#Structure" title="Permalink"></a></h1><p>The example is structured with two distinct components: 1) L96 dynamical system solver; 2) calibrate-emulate sample code. Each of these are described below.</p><p>Forward model: The forward mapping from input parameters to output statistics of the L96 system is solved using the <code>GModel.jl</code> code, which runs the L96 model across different input parameters <span>$\theta$</span>. The source code for the L96 system solution is within the <code>GModel_common.jl</code> code. </p><p>Calibrate: The main code is located in <code>calibrate.jl</code> which provides the functionality to run the L96 dynamical system (within the <code>GModel.jl</code> code), extract time-averaged statistics from the L96 states, and use the time-average statistics for calibration.</p><p>Emulate-sample: The main code is located in <code>emulate_sample.jl</code> which provides the functionality to run the L96 dynamical system, extract time-averaged statistics from the L96 states, and use the time-average statistics for emulation and sampling (uncertainty quantification).</p><h1 id="Inputs"><a class="docs-heading-anchor" href="#Inputs">Inputs</a><a id="Inputs-1"></a><a class="docs-heading-anchor-permalink" href="#Inputs" title="Permalink"></a></h1><p>Lorenz dynamics settings: The use of the transient forcing term is with the flag, <code>dynamics</code>. Stationary forcing is <code>dynamics=1</code> (<span>$A=0$</span>) and transient forcing is used with <code>dynamics=2</code> (<span>$A\neq0$</span>). The default parameters are specified in <code>Lorenz_example.jl</code> and can be modified as necessary. The system is solved over time horizon <span>$0$</span> to <code>tend</code> at fixed time step <code>dt</code>.</p><pre><code class="language-julia hljs">N = 36
dt = 1/64
t_start = 800</code></pre><p>Inverse problem settings: The states are integrated over time <code>Ts_days</code> to construct the time averaged statistics for use by the optimization. The specification of the statistics to be gathered from the states are provided by <code>stats_type</code>. The Ensemble Kalman Process (EKP) settings are</p><pre><code class="language-julia hljs">N_ens = 20 # number of ensemble members
N_iter = 5 # number of EKI iterations</code></pre><p>Setting up the Inverse Problem: The goal is to learn <code>F_s</code> and <code>A</code> based on the time averaged statistics in a perfect model setting. The true parameters are</p><pre><code class="language-julia hljs">F_true = 8. # Mean F
A_true = 2.5 # Transient F amplitude
ω_true = 2. * π / (360. / τc) # Frequency of the transient F
params_true = [F_true, A_true]
param_names = [&quot;F&quot;, &quot;A&quot;]</code></pre><p>Priors: We implement (biased) priors as follows</p><pre><code class="language-julia hljs">prior_means = [F_true + 1.0, A_true + 0.5]
prior_stds = [2.0, 0.5 * A_true]
# constrained_gaussian(&quot;name&quot;, desired_mean, desired_std, lower_bd, upper_bd)
prior_F = constrained_gaussian(param_names[1], prior_means[1], prior_stds[1], 0, Inf)
prior_A = constrained_gaussian(param_names[2], prior_means[2], prior_stds[2], 0, Inf)
priors = combine_distributions([prior_F, prior_A])</code></pre><p>We use the recommended [<code>constrained_gaussian</code>] to add the desired scale and bounds to the prior distribution, in particular we place lower bounds to preserve positivity. </p><p>Observational Noise: The observational noise can be generated using the L96 system or prescribed, as specified by <code>var_prescribe</code>. </p><p><code>var_prescribe==false</code> The observational noise is constructed by generating independent instantiations of the L96 statistics of interest at the true parameters for different initial conditions. The empirical covariance matrix is constructed.</p><p><code>var_prescribe==true</code> The observational noise is prescribed as a Gaussian distribution with prescribed mean and variance.</p><p>Machine learning emulation settings: We have 9 cases that the user can toggle or customize</p><pre><code class="language-julia hljs">cases = [
    &quot;gp-skljl&quot;,
    &quot;gp-gpjl&quot;, # Very slow prediction...
    &quot;rf-scalar&quot;,
    &quot;rf-svd-diag&quot;,
    &quot;rf-svd-nondiag&quot;,
    &quot;rf-nosvd-diag&quot;,
    &quot;rf-nosvd-nondiag&quot;,
    &quot;rf-svd-nonsep&quot;,
    &quot;rf-nosvd-nonsep&quot;,
]</code></pre><p>The first two are for GP with either <code>ScikitLearn.jl</code> or <code>GaussianProcesses.jl</code> interface. The third is for the scalar RF interface, which most closely follows exactly replacing a GP. The rest are examples of vector RF with different types of data processing, (svd = same processing as scalar RF, nosvd = unprocessed) and different RF kernel structures in the output space of increasing complexity/flexibility (diag = Separable diagonal, nondiag = Separable nondiagonal, nonsep = nonseparable nondiagonal).</p><h1 id="Running-the-Example-and-Postprocessing"><a class="docs-heading-anchor" href="#Running-the-Example-and-Postprocessing">Running the Example and Postprocessing</a><a id="Running-the-Example-and-Postprocessing-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-Example-and-Postprocessing" title="Permalink"></a></h1><p>First, the calibrate code must be executed, which will perform the calibration step and, generating input-output pairs of the parameter to data mapping. Then, the emulate-sample code is run, which will load the input-ouput pairs that were generated in the calibration step.</p><h2 id="Calibrate"><a class="docs-heading-anchor" href="#Calibrate">Calibrate</a><a id="Calibrate-1"></a><a class="docs-heading-anchor-permalink" href="#Calibrate" title="Permalink"></a></h2><p>Code execution: The L96 parameter estimation can be run using <code>julia --project calibrate.jl</code></p><p>Solution and Output: The output will provide the estimated parameters in the constrained <code>ϕ</code>-space. The <code>priors</code> are required in the get-method to apply these constraints.</p><p>Printed output:</p><pre><code class="language-julia hljs"># EKI results: Has the ensemble collapsed toward the truth?
println(&quot;True parameters: &quot;)
println(params_true)
println(&quot;\nEKI results:&quot;)
println(get_ϕ_mean_final(priors, ekiobj))</code></pre><p>Saved output: The parameters and forward model outputs will be saved in <code>parameter_storage.jld2</code> and <code>data_storage.jld2</code>, respectively. The data will be saved in the directory <code>output</code>.</p><p>Plots: A scatter plot animation of the ensemble convergence to the true parameters is saved in the directory <code>output</code>.</p><h2 id="Emulate-sample"><a class="docs-heading-anchor" href="#Emulate-sample">Emulate-sample</a><a id="Emulate-sample-1"></a><a class="docs-heading-anchor-permalink" href="#Emulate-sample" title="Permalink"></a></h2><p>Code execution: The L96 parameter estimation can be run using <code>julia --project emulate_sample.jl</code></p><p>Solution and Output: The output will provide the estimated posterior distribution over the parameters. The emulate-sample code will run for several choices in the machine learning model that is used for the emulation stage, inclding Gaussian Process regression and RF, and using singular value data decorrelation or not. </p><h1 id="L96-CES-example-case:-GP-regression-emulator"><a class="docs-heading-anchor" href="#L96-CES-example-case:-GP-regression-emulator">L96 CES example case: GP regression emulator</a><a id="L96-CES-example-case:-GP-regression-emulator-1"></a><a class="docs-heading-anchor-permalink" href="#L96-CES-example-case:-GP-regression-emulator" title="Permalink"></a></h1><p>Calibrate:</p><img src="../assets/Lorenz-training-points.png" width="600"><p>Emulate-sample:</p><img src="../assets/Lorenz-posterior.png" width="600"></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../emulate/">« Emulate</a><a class="docs-footer-nextpage" href="../edmf_example/">Turbulence example »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Monday 27 November 2023 20:56">Monday 27 November 2023</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Lorenz example · CalibrateEmulateSample.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="CalibrateEmulateSample.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">CalibrateEmulateSample.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li><li><a class="tocitem" href="../../calibrate/">Calibrate</a></li><li><a class="tocitem" href="../../emulate/">Emulate</a></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox" checked/><label class="tocitem" for="menuitem-6"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Lorenz example</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#MFH-to-update"><span>MFH to update</span></a></li><li class="toplevel"><a class="tocitem" href="#Overview"><span>Overview</span></a></li><li><a class="tocitem" href="#Lorenz-96-equations"><span>Lorenz 96 equations</span></a></li><li class="toplevel"><a class="tocitem" href="#Structure"><span>Structure</span></a></li><li><a class="tocitem" href="#L96-forward-model"><span>L96 forward model</span></a></li><li><a class="tocitem" href="#Calibrate"><span>Calibrate</span></a></li><li><a class="tocitem" href="#Emulate-sample"><span>Emulate-sample</span></a></li><li class="toplevel"><a class="tocitem" href="#Inputs"><span>Inputs</span></a></li><li><a class="tocitem" href="#Lorenz-dynamics-settings"><span>Lorenz dynamics settings</span></a></li><li><a class="tocitem" href="#Inverse-problem-settings"><span>Inverse problem settings</span></a></li><li><a class="tocitem" href="#Setting-up-the-Inverse-Problem"><span>Setting up the Inverse Problem</span></a></li><li><a class="tocitem" href="#Priors"><span>Priors</span></a></li><li><a class="tocitem" href="#Observational-Noise"><span>Observational Noise</span></a></li><li><a class="tocitem" href="#Machine-learning-emulation-settings"><span>Machine learning emulation settings</span></a></li><li class="toplevel"><a class="tocitem" href="#Running-the-Example-and-Postprocessing"><span>Running the Example and Postprocessing</span></a></li><li><a class="tocitem" href="#Calibrate-2"><span>Calibrate</span></a></li><li><a class="tocitem" href="#Emulate-sample-2"><span>Emulate-sample</span></a></li><li><a class="tocitem" href="#Generic-text"><span>Generic text</span></a></li><li><a class="tocitem" href="#The-structure-of-the-example-script"><span>The structure of the example script</span></a></li></ul></li><li><a class="tocitem" href="../edmf_example/">Turbulence example</a></li></ul></li><li><a class="tocitem" href="../../GaussianProcessEmulator/">Gaussian Process</a></li><li><a class="tocitem" href="../../random_feature_emulator/">Random Features</a></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">Package Design</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../API/AbstractMCMC/">AbstractMCMC sampling API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox"/><label class="tocitem" for="menuitem-10"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-10-1" type="checkbox"/><label class="tocitem" for="menuitem-10-1"><span class="docs-label">CalibrateEmulateSample</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-10-1-1" type="checkbox"/><label class="tocitem" for="menuitem-10-1-1"><span class="docs-label">Emulators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../API/Emulators/">General Interface</a></li><li><a class="tocitem" href="../../API/GaussianProcess/">Gaussian Process</a></li><li><a class="tocitem" href="../../API/RandomFeatures/">Random Features</a></li></ul></li><li><a class="tocitem" href="../../API/MarkovChainMonteCarlo/">MarkovChainMonteCarlo</a></li><li><a class="tocitem" href="../../API/Utilities/">Utilities</a></li></ul></li></ul></li><li><a class="tocitem" href="../../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Lorenz example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Lorenz example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/CalibrateEmulateSample.jl/blob/main/docs/src/examples/lorenz_example.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Lorenz-96-example"><a class="docs-heading-anchor" href="#Lorenz-96-example">Lorenz 96 example</a><a id="Lorenz-96-example-1"></a><a class="docs-heading-anchor-permalink" href="#Lorenz-96-example" title="Permalink"></a></h1><h1 id="MFH-to-update"><a class="docs-heading-anchor" href="#MFH-to-update">MFH to update</a><a id="MFH-to-update-1"></a><a class="docs-heading-anchor-permalink" href="#MFH-to-update" title="Permalink"></a></h1><h1 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h1><p>The Lorenz 96 (hereafter L96) example is a toy-problem for the application of the CalibrateEmulateSample.jl optimization and approximate uncertainty quantification methodologies. Here is L96 with additional periodic-in-time forcing, we try to determine parameters (sinusoidal amplitude and stationary component of the forcing) from some output statistics. The standard L96 equations are implemented with an additional forcing term with time dependence. The output statistics which are used for learning are the finite time-averaged variances.</p><h2 id="Lorenz-96-equations"><a class="docs-heading-anchor" href="#Lorenz-96-equations">Lorenz 96 equations</a><a id="Lorenz-96-equations-1"></a><a class="docs-heading-anchor-permalink" href="#Lorenz-96-equations" title="Permalink"></a></h2><p>The standard single-scale L96 equations are implemented. The Lorenz 96 system (<a href="http://www.raidl.cz/file/18/lorenz-1996-_predictability_partly_solved.pdf">Lorenz, 1996</a>) is given by </p><p class="math-container">\[\frac{d x_i}{d t} = (x_{i+1} - x_{i-2}) x_{i-1} - x_i + F,\]</p><p>with <span>$i$</span> indicating the index of the given longitude. The number of longitudes is given by <span>$N$</span>. The boundary conditions are given by</p><p class="math-container">\[x_{-1} = x_{N-1}, \ x_0 = x_N, \ x_{N+1} = x_1.\]</p><p>The time scaling is such that the characteristic time is 5 days (<a href="http://www.raidl.cz/file/18/lorenz-1996-_predictability_partly_solved.pdf">Lorenz, 1996</a>).  For very small values of <span>$F$</span>, the solutions <span>$x_i$</span> decay to <span>$F$</span> after the initial transient feature. For moderate values of <span>$F$</span>, the solutions are periodic, and for larger values of <span>$F$</span>, the system is chaotic. The solution variance is a function of the forcing magnitude. Variations in the base state as a function of time can be imposed through a time-dependent forcing term <span>$F(t)$</span>.</p><p>A temporal forcing term is defined</p><p class="math-container">\[F = F_s + A \sin(\omega t),\]</p><p>with steady-state forcing <span>$F_s$</span>, transient forcing amplitude <span>$A$</span>, and transient forcing frequency <span>$\omega$</span>. The total forcing <span>$F$</span> must be within the chaotic regime of L96 for all time given the prescribed <span>$N$</span>.</p><p>The L96 dynamics are solved with RK4 integration.</p><h1 id="Structure"><a class="docs-heading-anchor" href="#Structure">Structure</a><a id="Structure-1"></a><a class="docs-heading-anchor-permalink" href="#Structure" title="Permalink"></a></h1><p>The example is structured with two distinct components: 1) L96 dynamical system solver; 2) calibrate-emulate sample code. Each of these are described below.</p><h2 id="L96-forward-model"><a class="docs-heading-anchor" href="#L96-forward-model">L96 forward model</a><a id="L96-forward-model-1"></a><a class="docs-heading-anchor-permalink" href="#L96-forward-model" title="Permalink"></a></h2><p>The forward mapping from input parameters to output statistics of the L96 system is solved using the <code>GModel.jl</code> code, which runs the L96 model across different input parameters <span>$\theta$</span>. The source code for the L96 system solution is within the <code>GModel_common.jl</code> code. </p><h2 id="Calibrate"><a class="docs-heading-anchor" href="#Calibrate">Calibrate</a><a id="Calibrate-1"></a><a class="docs-heading-anchor-permalink" href="#Calibrate" title="Permalink"></a></h2><p>The main code is located in <code>calibrate.jl</code> which provides the functionality to run the L96 dynamical system (within the <code>GModel.jl</code> code), extract time-averaged statistics from the L96 states, and use the time-average statistics for calibration.</p><h2 id="Emulate-sample"><a class="docs-heading-anchor" href="#Emulate-sample">Emulate-sample</a><a id="Emulate-sample-1"></a><a class="docs-heading-anchor-permalink" href="#Emulate-sample" title="Permalink"></a></h2><p>The main code is located in <code>emulate_sample.jl</code> which provides the functionality to run the L96 dynamical system, extract time-averaged statistics from the L96 states, and use the time-average statistics for emulation and sampling (uncertainty quantification).</p><h1 id="Inputs"><a class="docs-heading-anchor" href="#Inputs">Inputs</a><a id="Inputs-1"></a><a class="docs-heading-anchor-permalink" href="#Inputs" title="Permalink"></a></h1><h2 id="Lorenz-dynamics-settings"><a class="docs-heading-anchor" href="#Lorenz-dynamics-settings">Lorenz dynamics settings</a><a id="Lorenz-dynamics-settings-1"></a><a class="docs-heading-anchor-permalink" href="#Lorenz-dynamics-settings" title="Permalink"></a></h2><p>The use of the transient forcing term is with the flag, <code>dynamics</code>. Stationary forcing is <code>dynamics=1</code> (<span>$A=0$</span>) and transient forcing is used with <code>dynamics=2</code> (<span>$A\neq0$</span>). The default parameters are specified in <code>Lorenz_example.jl</code> and can be modified as necessary. The system is solved over time horizon <span>$0$</span> to <code>tend</code> at fixed time step <code>dt</code>.</p><pre><code class="language-julia hljs">N = 36
dt = 1/64
t_start = 800</code></pre><h2 id="Inverse-problem-settings"><a class="docs-heading-anchor" href="#Inverse-problem-settings">Inverse problem settings</a><a id="Inverse-problem-settings-1"></a><a class="docs-heading-anchor-permalink" href="#Inverse-problem-settings" title="Permalink"></a></h2><p>The states are integrated over time <code>Ts_days</code> to construct the time averaged statistics for use by the optimization. The specification of the statistics to be gathered from the states are provided by <code>stats_type</code>. The Ensemble Kalman Process (EKP) settings are</p><pre><code class="language-julia hljs">N_ens = 20 # number of ensemble members
N_iter = 5 # number of EKI iterations</code></pre><h2 id="Setting-up-the-Inverse-Problem"><a class="docs-heading-anchor" href="#Setting-up-the-Inverse-Problem">Setting up the Inverse Problem</a><a id="Setting-up-the-Inverse-Problem-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up-the-Inverse-Problem" title="Permalink"></a></h2><p>The goal is to learn <code>F_s</code> and <code>A</code> based on the time averaged statistics in a perfect model setting. The true parameters are</p><pre><code class="language-julia hljs">F_true = 8. # Mean F
A_true = 2.5 # Transient F amplitude
ω_true = 2. * π / (360. / τc) # Frequency of the transient F
params_true = [F_true, A_true]
param_names = [&quot;F&quot;, &quot;A&quot;]</code></pre><h2 id="Priors"><a class="docs-heading-anchor" href="#Priors">Priors</a><a id="Priors-1"></a><a class="docs-heading-anchor-permalink" href="#Priors" title="Permalink"></a></h2><p>We implement (biased) priors as follows</p><pre><code class="language-julia hljs">prior_means = [F_true + 1.0, A_true + 0.5]
prior_stds = [2.0, 0.5 * A_true]
# constrained_gaussian(&quot;name&quot;, desired_mean, desired_std, lower_bd, upper_bd)
prior_F = constrained_gaussian(param_names[1], prior_means[1], prior_stds[1], 0, Inf)
prior_A = constrained_gaussian(param_names[2], prior_means[2], prior_stds[2], 0, Inf)
priors = combine_distributions([prior_F, prior_A])</code></pre><p>We use the recommended [<code>constrained_gaussian</code>] to add the desired scale and bounds to the prior distribution, in particular we place lower bounds to preserve positivity. </p><h2 id="Observational-Noise"><a class="docs-heading-anchor" href="#Observational-Noise">Observational Noise</a><a id="Observational-Noise-1"></a><a class="docs-heading-anchor-permalink" href="#Observational-Noise" title="Permalink"></a></h2><p>The observational noise can be generated using the L96 system or prescribed, as specified by <code>var_prescribe</code>. </p><p><code>var_prescribe==false</code> The observational noise is constructed by generating independent instantiations of the L96 statistics of interest at the true parameters for different initial conditions. The empirical covariance matrix is constructed.</p><p><code>var_prescribe==true</code> The observational noise is prescribed as a Gaussian distribution with prescribed mean and variance.</p><h2 id="Machine-learning-emulation-settings"><a class="docs-heading-anchor" href="#Machine-learning-emulation-settings">Machine learning emulation settings</a><a id="Machine-learning-emulation-settings-1"></a><a class="docs-heading-anchor-permalink" href="#Machine-learning-emulation-settings" title="Permalink"></a></h2><p>Describe the emulator approach used</p><h1 id="Running-the-Example-and-Postprocessing"><a class="docs-heading-anchor" href="#Running-the-Example-and-Postprocessing">Running the Example and Postprocessing</a><a id="Running-the-Example-and-Postprocessing-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-Example-and-Postprocessing" title="Permalink"></a></h1><p>First, the calibrate code must be executed, which will perform the calibration step and, generating input-output pairs of the parameter to data mapping. Then, the emulate-sample code is run, which will load the input-ouput pairs that were generated in the calibration step.</p><h2 id="Calibrate-2"><a class="docs-heading-anchor" href="#Calibrate-2">Calibrate</a><a class="docs-heading-anchor-permalink" href="#Calibrate-2" title="Permalink"></a></h2><h3 id="Code-execution"><a class="docs-heading-anchor" href="#Code-execution">Code execution</a><a id="Code-execution-1"></a><a class="docs-heading-anchor-permalink" href="#Code-execution" title="Permalink"></a></h3><p>The L96 parameter estimation can be run using <code>julia --project calibrate.jl</code></p><h3 id="Solution-and-Output"><a class="docs-heading-anchor" href="#Solution-and-Output">Solution and Output</a><a id="Solution-and-Output-1"></a><a class="docs-heading-anchor-permalink" href="#Solution-and-Output" title="Permalink"></a></h3><p>The output will provide the estimated parameters in the constrained <code>ϕ</code>-space. The <code>priors</code> are required in the get-method to apply these constraints.</p><h3 id="Printed-output"><a class="docs-heading-anchor" href="#Printed-output">Printed output</a><a id="Printed-output-1"></a><a class="docs-heading-anchor-permalink" href="#Printed-output" title="Permalink"></a></h3><pre><code class="language-julia hljs"># EKI results: Has the ensemble collapsed toward the truth?
println(&quot;True parameters: &quot;)
println(params_true)
println(&quot;\nEKI results:&quot;)
println(get_ϕ_mean_final(priors, ekiobj))</code></pre><h3 id="Saved-output"><a class="docs-heading-anchor" href="#Saved-output">Saved output</a><a id="Saved-output-1"></a><a class="docs-heading-anchor-permalink" href="#Saved-output" title="Permalink"></a></h3><p>The parameters and forward model outputs will be saved in <code>parameter_storage.jld2</code> and <code>data_storage.jld2</code>, respectively. The data will be saved in the directory <code>output</code>.</p><h3 id="Plots"><a class="docs-heading-anchor" href="#Plots">Plots</a><a id="Plots-1"></a><a class="docs-heading-anchor-permalink" href="#Plots" title="Permalink"></a></h3><p>A scatter plot animation of the ensemble convergence to the true parameters is saved in the directory <code>output</code>.</p><h2 id="Emulate-sample-2"><a class="docs-heading-anchor" href="#Emulate-sample-2">Emulate-sample</a><a class="docs-heading-anchor-permalink" href="#Emulate-sample-2" title="Permalink"></a></h2><h3 id="Code-execution-2"><a class="docs-heading-anchor" href="#Code-execution-2">Code execution</a><a class="docs-heading-anchor-permalink" href="#Code-execution-2" title="Permalink"></a></h3><p>The L96 parameter estimation can be run using <code>julia --project emulate_sample.jl</code></p><h3 id="Solution-and-Output-2"><a class="docs-heading-anchor" href="#Solution-and-Output-2">Solution and Output</a><a class="docs-heading-anchor-permalink" href="#Solution-and-Output-2" title="Permalink"></a></h3><p>The output will provide the estimated posterior distribution over the parameters. The emulate-sample code will run for several choices in the machine learning model that is used for the emulation stage, inclding Gaussian Process regression and RF, and using singular value data decorrelation or not. </p><h2 id="Generic-text"><a class="docs-heading-anchor" href="#Generic-text">Generic text</a><a id="Generic-text-1"></a><a class="docs-heading-anchor-permalink" href="#Generic-text" title="Permalink"></a></h2><p>We provide the following template for how the tools may be applied.</p><p>For small examples typically have 2 files.</p><ul><li><code>GModel.jl</code> Contains the forward map. The inputs should be the so-called free parameters we are interested in learning, and the output should be the measured data</li><li>The example script which contains the inverse problem setup and solve</li></ul><h2 id="The-structure-of-the-example-script"><a class="docs-heading-anchor" href="#The-structure-of-the-example-script">The structure of the example script</a><a id="The-structure-of-the-example-script-1"></a><a class="docs-heading-anchor-permalink" href="#The-structure-of-the-example-script" title="Permalink"></a></h2><p>First we create the data and the setting for the model</p><ol><li>Set up the forward model.</li><li>Construct/load the truth data. Store this data conveniently in the <code>Observations.Observation</code> object</li></ol><p>Then we set up the inverse problem</p><ol><li>Define the prior distributions. Use the <code>ParameterDistribution</code> object</li><li>Decide on which <code>process</code> tool you would like to use (we recommend you begin with <code>Invesion()</code>). Then initialize this with the relevant constructor</li><li>initialize the <code>EnsembleKalmanProcess</code> object</li></ol><p>Then we solve the inverse problem, in a loop perform the following for as many iterations as required:</p><ol><li>Obtain the current parameter ensemble</li><li>Transform them from the unbounded computational space to the physical space</li><li>call the forward map on the ensemble of parameters, producing an ensemble of measured data</li><li>call the <code>update_ensemble!</code> function to generate a new parameter ensemble based on the new data</li></ol><p>One can then obtain the solution, dependent on the <code>process</code> type.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../emulate/">« Emulate</a><a class="docs-footer-nextpage" href="../edmf_example/">Turbulence example »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Monday 27 November 2023 00:25">Monday 27 November 2023</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

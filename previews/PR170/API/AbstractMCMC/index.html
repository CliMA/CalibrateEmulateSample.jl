<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>AbstractMCMC sampling API · CalibrateEmulateSample.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="CalibrateEmulateSample.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">CalibrateEmulateSample.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li><li><a class="tocitem" href="../../calibrate/">Calibrate</a></li><li><a class="tocitem" href="../../emulate/">Emulate</a></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/lorenz_example/">Lorenz example</a></li><li><a class="tocitem" href="../../examples/edmf_example/">Turbulence example</a></li></ul></li><li><a class="tocitem" href="../../GaussianProcessEmulator/">Gaussian Process</a></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox" checked/><label class="tocitem" for="menuitem-8"><span class="docs-label">Package Design</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>AbstractMCMC sampling API</a><ul class="internal"><li><a class="tocitem" href="#Use-in-MarkovChainMonteCarlo"><span>Use in MarkovChainMonteCarlo</span></a></li><li><a class="tocitem" href="#Classes-and-methods"><span>Classes and methods</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-9-1" type="checkbox"/><label class="tocitem" for="menuitem-9-1"><span class="docs-label">CalibrateEmulateSample</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-9-1-1" type="checkbox"/><label class="tocitem" for="menuitem-9-1-1"><span class="docs-label">Emulators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../Emulators/">General Emulator</a></li><li><a class="tocitem" href="../GaussianProcess/">Gaussian Process</a></li></ul></li><li><a class="tocitem" href="../MarkovChainMonteCarlo/">MarkovChainMonteCarlo</a></li><li><a class="tocitem" href="../Utilities/">Utilities</a></li></ul></li></ul></li><li><a class="tocitem" href="../../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Package Design</a></li><li class="is-active"><a href>AbstractMCMC sampling API</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>AbstractMCMC sampling API</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/CalibrateEmulateSample.jl/blob/master/docs/src/API/AbstractMCMC.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="AbstractMCMC-sampling-API"><a class="docs-heading-anchor" href="#AbstractMCMC-sampling-API">AbstractMCMC sampling API</a><a id="AbstractMCMC-sampling-API-1"></a><a class="docs-heading-anchor-permalink" href="#AbstractMCMC-sampling-API" title="Permalink"></a></h1><p>The &quot;sample&quot; part of CES refers to exact sampling from the emulated posterior via <a href="https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo">Markov chain Monte Carlo</a> (MCMC). Within this paradigm, we want to provide the flexibility to use multiple sampling algorithms; the approach we take is to use the general-purpose <a href="https://turing.ml/dev/docs/for-developers/interface">AbstractMCMC.jl</a> API, provided by the <a href="https://turing.ml/dev/">Turing.jl</a> probabilistic programming framework.</p><p>This page provides a summary of AbstractMCMC which augments the existing documentation ([<a href="https://turing.ml/dev/docs/for-developers/interface">1</a>], [<a href="https://turing.ml/dev/docs/for-developers/how_turing_implements_abstractmcmc">2</a>]) and highlights how it&#39;s used by the CES package in <a href="../MarkovChainMonteCarlo/#MarkovChainMonteCarlo">MarkovChainMonteCarlo</a>. It&#39;s not meant to be a complete description of the AbstractMCMC package.</p><h2 id="Use-in-MarkovChainMonteCarlo"><a class="docs-heading-anchor" href="#Use-in-MarkovChainMonteCarlo">Use in MarkovChainMonteCarlo</a><a id="Use-in-MarkovChainMonteCarlo-1"></a><a class="docs-heading-anchor-permalink" href="#Use-in-MarkovChainMonteCarlo" title="Permalink"></a></h2><p>At present, Turing has limited support for derivative-free optimization, so we only use this abstract API and not Turing itself. We also use two related dependencies, <a href="https://github.com/TuringLang/AdvancedMH.jl">AdvancedMH</a> and <a href="https://github.com/TuringLang/MCMCChains.jl">MCMCChains</a>. </p><p>Julia&#39;s philosophy is to use small, composable packages rather than monoliths, but this can make it difficult to remember where methods are defined! Below we describe the relevant parts of </p><ul><li>The AbstractMCMC API,</li><li>Extended to the case of Metropolis-Hastings (MH) sampling by AdvancedMH,</li><li>Further extended for the needs of CES in <a href="https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo">Markov chain Monte Carlo</a>.</li></ul><h2 id="Classes-and-methods"><a class="docs-heading-anchor" href="#Classes-and-methods">Classes and methods</a><a id="Classes-and-methods-1"></a><a class="docs-heading-anchor-permalink" href="#Classes-and-methods" title="Permalink"></a></h2><h3 id="Sampler"><a class="docs-heading-anchor" href="#Sampler">Sampler</a><a id="Sampler-1"></a><a class="docs-heading-anchor-permalink" href="#Sampler" title="Permalink"></a></h3><p>A Sampler is AbstractMCMC&#39;s term for an implementation of a MCMC sampling algorithm, along with all its configuration parameters. All samplers must inherit from <code>AbstractMCMC.AbstractSampler</code>. </p><p>Currently CES only implements the Metropolis-Hastings (MH) algorithm. Because it&#39;s so straightforward, much of AbstractMCMC isn&#39;t needed. We implement two variants of MH with two different Samplers: <code>RWMetropolisHastings</code> and <code>pCNMetropolisHastings</code>, both of which inherit from the <code>AdvancedMH.MHSampler</code> base class. The public constructor for both Samplers is <a href="../MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.MetropolisHastingsSampler"><code>MetropolisHastingsSampler</code></a>; the different Samplers are specified by passing a <a href="../MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.MCMCProtocol"><code>MCMCProtocol</code></a> object to this constructor.</p><p>The MH Sampler classes have only one field, <code>proposal</code>, which is the distribution used to generate new MH proposals via stochastic offsets to the current parameter values. This is done by <a href="https://github.com/TuringLang/AdvancedMH.jl/blob/master/src/proposal.jl">AdvancedMH.propose()</a>, which gets called for each MCMC <code>step()</code> (below). The difference between our two Samplers is in how this proposal is generated:</p><ul><li><p><a href="../MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.RWMHSampling"><code>RWMHSampling</code></a> does vanilla random-walk proposal generation with a constant, user-specified step size (this differs from the AdvancedMH implementation, which doesn&#39;t provide for a step size.)</p></li><li><p><a href="../MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.pCNMHSampling"><code>pCNMHSampling</code></a> for preconditioned Crank-Nicholson proposals. Vanilla random walk sampling doesn&#39;t have a well-defined limit for high-dimensional parameter spaces; pCN replaces the random walk with an Ornstein–Uhlenbeck [AR(1)] process so that the Metropolis acceptance probability remains non-zero in this limit. See <a href="https://www.worldscientific.com/doi/abs/10.1142/S0219493708002378">Beskos et. al. (2008)</a> and <a href="https://projecteuclid.org/journals/statistical-science/volume-28/issue-3/MCMC-Methods-for-Functions--Modifying-Old-Algorithms-to-Make/10.1214/13-STS421.full">Cotter et. al. (2013)</a>.</p></li></ul><p>This is the only difference: generated proposals are then either accepted or rejected according to the same MH criterion (in <code>step()</code>, below.)</p><h3 id="Models"><a class="docs-heading-anchor" href="#Models">Models</a><a id="Models-1"></a><a class="docs-heading-anchor-permalink" href="#Models" title="Permalink"></a></h3><p>In Turing, the Model is the distribution one performs inference on, which may involve observed and hidden variables and parameters. For CES, we simply want to sample from the posterior, so our Model distribution is simply the emulated likelihood (see <a href="../Emulators/#Emulators">Emulators</a>) together with the prior. This is constructed by <a href="../MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.EmulatorPosteriorModel"><code>EmulatorPosteriorModel</code></a>.</p><h3 id="Sampling-with-the-MCMC-Wrapper-object"><a class="docs-heading-anchor" href="#Sampling-with-the-MCMC-Wrapper-object">Sampling with the MCMC Wrapper object</a><a id="Sampling-with-the-MCMC-Wrapper-object-1"></a><a class="docs-heading-anchor-permalink" href="#Sampling-with-the-MCMC-Wrapper-object" title="Permalink"></a></h3><p>At a <a href="https://turing.ml/dev/docs/using-turing/guide">high level</a>, a Sampler and Model is all that&#39;s needed to do MCMC sampling. This is done by the <a href="https://github.com/TuringLang/AbstractMCMC.jl/blob/master/src/sample.jl"><code>sample</code></a> method provided by AbstractMCMC (extending the method from BaseStats). </p><p>To be more user-friendly, in CES we wrap the Sampler, Model and other necessary configuration into a <a href="../MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.MCMCWrapper"><code>MCMCWrapper</code></a> object. The constructor for this object ensures that all its components are created consistently, and performs necessary bookkeeping, such as converting coordinates to the decorrelated basis. We extend <a href="../MarkovChainMonteCarlo/#StatsBase.sample"><code>sample</code></a> with methods to use this object (that simply unpack its fields and call the appropriate method from AbstractMCMC.)</p><h3 id="Chain"><a class="docs-heading-anchor" href="#Chain">Chain</a><a id="Chain-1"></a><a class="docs-heading-anchor-permalink" href="#Chain" title="Permalink"></a></h3><p>The <a href="https://beta.turing.ml/MCMCChains.jl/dev/">MCMCChain</a> class is used to store the results of the MCMC sampling; the package provides simple diagnostics for visualization and diagnosing chain convergence.</p><h3 id="Internals:-Transitions"><a class="docs-heading-anchor" href="#Internals:-Transitions">Internals: Transitions</a><a id="Internals:-Transitions-1"></a><a class="docs-heading-anchor-permalink" href="#Internals:-Transitions" title="Permalink"></a></h3><p>Implementing MCMC involves defining states and transitions of a Markov process (whose stationary distribution is what we seek to sample from). AbstractMCMC&#39;s terminology is a bit confusing for the MH case; <em>states</em> of the chain are described by <code>Transition</code> objects, which contain the current sample (and other information like its log-probability). </p><p>AdvancedMH defines an <code>AbstractTransition</code> base class for use with its methods; we implement our own child class, <a href="../MarkovChainMonteCarlo/#CalibrateEmulateSample.MarkovChainMonteCarlo.MCMCState"><code>MCMCState</code></a>, in order to record statistics on the MH acceptance ratio.</p><h3 id="Internals:-Markov-steps"><a class="docs-heading-anchor" href="#Internals:-Markov-steps">Internals: Markov steps</a><a id="Internals:-Markov-steps-1"></a><a class="docs-heading-anchor-permalink" href="#Internals:-Markov-steps" title="Permalink"></a></h3><p>Markov <em>transitions</em> of the chain are defined by overloading AbstractMCMC&#39;s <code>step</code> method, which takes the Sampler and current <code>Transition</code> and implements the Sampler&#39;s logic to returns an updated <code>Transition</code> representing the chain&#39;s new state (actually, a pair of <code>Transitions</code>, for cases where the Sampler doesn&#39;t obey detailed balance; this isn&#39;t relevant for us). </p><p>For example, in Metropolis-Hastings sampling this is where we draw a proposal sample and accept or reject it according to the MH criterion. AdvancedMH implements this <a href="https://github.com/TuringLang/AdvancedMH.jl/blob/ba86e49a3ebd1ee94d0becc3211738e3be6fd538/src/mh-core.jl#L90-L113">here</a>; we re-implement this method because 1) we need to record whether a proposal was accepted or rejected, and 2) our calls to <code>propose()</code> are stepsize-dependent.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../GaussianProcessEmulator/">« Gaussian Process</a><a class="docs-footer-nextpage" href="../Emulators/">General Emulator »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Wednesday 5 October 2022 20:24">Wednesday 5 October 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
